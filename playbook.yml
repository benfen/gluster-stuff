---
- hosts: gluster

  tasks:
    - name: Create mount point for gluster
      become: yes
      file:
        path: "{{ gluster_brick }}"
        state: directory

    - name: Install the glusterfs server
      become: yes
      package:
        name: "{{ item }}"
        state: latest
      with_items:
        - glusterfs-server

    - name: Start glusterfs service
      become: yes
      service:
        name: glusterd
        state: started

    - name: Ensure firewall for each instance is opened
      become: yes
      firewalld:
        zone: trusted
        state: enabled
        source: "{{ item }}"
        immediate: yes
        permanent: yes
      with_items: "{{ cluster_ips }}"

    - name: Force the firewall to reload to clean up after Ansible
      become: yes
      shell: "firewall-cmd --reload"

    - name: Create gluster volume
      become: yes
      gluster_volume:
        name: "{{ gluster_volume }}"
        force: yes
        state: present
        rebalance: yes
        replicas: 3
        bricks: "{{ gluster_brick }}"
        cluster: "{{ cluster_ips }}"
      run_once: true
...

